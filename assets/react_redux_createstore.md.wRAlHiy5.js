import{_ as n,c as a,o as l,ag as p}from"./chunks/framework.D-6U7MZ9.js";const e="/n-book/assets/createStore.bw6IBCfg.jpg",u=JSON.parse('{"title":"讲讲 Redux createStore 的实现原理","description":"","frontmatter":{},"headers":[],"relativePath":"react/redux_createstore.md","filePath":"react/redux_createstore.md","lastUpdated":1552970148000}'),o={name:"react/redux_createstore.md"};function r(t,s,c,i,y,A){return l(),a("div",null,s[0]||(s[0]=[p('<h1 id="讲讲-redux-createstore-的实现原理" tabindex="-1">讲讲 Redux createStore 的实现原理 <a class="header-anchor" href="#讲讲-redux-createstore-的实现原理" aria-label="Permalink to &quot;讲讲 Redux createStore 的实现原理&quot;">​</a></h1><p><img src="'+e+`" alt="createStore"></p><p>createStore 创建一个 Redux store 来以存放应用中所有的 state，应用中应有且仅有一个 store。其中暴露 dispatch, subscribe, getState, replaceReducer 方法。</p><h2 id="基本用法" tabindex="-1">基本用法 <a class="header-anchor" href="#基本用法" aria-label="Permalink to &quot;基本用法&quot;">​</a></h2><p>先看看 createStore 是怎么个用法：</p><p><code>createStore(reducer, [preloadedState], enhancer)</code></p><p><strong>参数</strong></p><p><code>reducer (Function)</code>: A reducing function that returns the next state tree, given the current state tree and an action to handle.(reducer 接收两个参数，分别是当前的 state 树和要处理的 action，返回新的 state 树。)</p><p><code>[preloadedState] (any)</code>: The initial state. You may optionally specify it to hydrate the state from the server in universal apps, or to restore a previously serialized user session. If you produced reducer with combineReducers, this must be a plain object with the same shape as the keys passed to it. Otherwise, you are free to pass anything that your reducer can understand.(初始时的 state。在同构应用中，你可以决定是否把服务端传来的 state hydrate 后传给它，或者从之前保存的用户会话中恢复一个传给它。如果你使用 combineReducers 创建 reducer，它必须是一个普通对象，与传入的 keys 保持同样的结构。否则，你可以自由传入任何 reducer 可理解的内容。)</p><p><code>[enhancer] (Function)</code>: The store enhancer. You may optionally specify it to enhance the store with third-party capabilities such as middleware, time travel, persistence, etc. The only store enhancer that ships with Redux is applyMiddleware().(store 的增强器函数，可以指定为第三方的中间件，时间旅行，持久化 等等，但是这个函数只能用 Redux 提供的 applyMiddleware 函数来生成；)</p><p><strong>返回值</strong></p><p>(Store): An object that holds the complete state of your app. The only way to change its state is by dispatching actions. You may also subscribe to the changes to its state to update the UI.(保存了所有 state 的对象。改变 state 的唯一方法是 dispatch action。你也可以 subscribe 监听 state 的变化，然后更新 UI。)</p><p><strong>示例</strong></p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki everforest-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#83C092;">import</span><span style="color:#D3C6AA;"> { createStore } </span><span style="color:#E67E80;">from</span><span style="color:#DBBC7F;"> &quot;redux&quot;</span><span style="color:#D3C6AA;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#859289;font-style:italic;">// 声明一个reducer</span></span>
<span class="line"><span style="color:#E67E80;">function</span><span style="color:#A7C080;"> todos</span><span style="color:#D3C6AA;">(state</span><span style="color:#E69875;"> =</span><span style="color:#D3C6AA;"> [],</span><span style="color:#D3C6AA;"> action)</span><span style="color:#D3C6AA;"> {</span></span>
<span class="line"><span style="color:#E69875;">  switch</span><span style="color:#D3C6AA;"> (action</span><span style="color:#859289;">.</span><span style="color:#D3C6AA;">type)</span><span style="color:#D3C6AA;"> {</span></span>
<span class="line"><span style="color:#E69875;">    case</span><span style="color:#DBBC7F;"> &quot;ADD_TODO&quot;</span><span style="color:#D3C6AA;">:</span></span>
<span class="line"><span style="color:#E67E80;">      return</span><span style="color:#D3C6AA;"> state</span><span style="color:#859289;">.</span><span style="color:#A7C080;">concat</span><span style="color:#D3C6AA;">([action</span><span style="color:#859289;">.</span><span style="color:#D3C6AA;">text]);</span></span>
<span class="line"><span style="color:#E69875;">    default</span><span style="color:#D3C6AA;">:</span></span>
<span class="line"><span style="color:#E67E80;">      return</span><span style="color:#D3C6AA;"> state;</span></span>
<span class="line"><span style="color:#D3C6AA;">  }</span></span>
<span class="line"><span style="color:#D3C6AA;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E69875;">let</span><span style="color:#D3C6AA;"> store </span><span style="color:#E69875;">=</span><span style="color:#A7C080;"> createStore</span><span style="color:#D3C6AA;">(todos, [</span><span style="color:#DBBC7F;">&quot;Use Redux&quot;</span><span style="color:#D3C6AA;">]);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D3C6AA;">store</span><span style="color:#859289;">.</span><span style="color:#A7C080;">dispatch</span><span style="color:#D3C6AA;">({</span></span>
<span class="line"><span style="color:#D3C6AA;">  type</span><span style="color:#859289;">:</span><span style="color:#DBBC7F;"> &quot;ADD_TODO&quot;</span><span style="color:#D3C6AA;">,</span></span>
<span class="line"><span style="color:#D3C6AA;">  text</span><span style="color:#859289;">:</span><span style="color:#DBBC7F;"> &quot;Read the docs&quot;</span></span>
<span class="line"><span style="color:#D3C6AA;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D3C6AA;">console</span><span style="color:#859289;">.</span><span style="color:#A7C080;">log</span><span style="color:#D3C6AA;">(store</span><span style="color:#859289;">.</span><span style="color:#A7C080;">getState</span><span style="color:#D3C6AA;">());</span></span>
<span class="line"><span style="color:#859289;font-style:italic;">// [ &#39;Use Redux&#39;, &#39;Read the docs&#39; ]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h2 id="源码及分析" tabindex="-1">源码及分析 <a class="header-anchor" href="#源码及分析" aria-label="Permalink to &quot;源码及分析&quot;">​</a></h2><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki everforest-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#859289;font-style:italic;">// 大体框架</span></span>
<span class="line"><span style="color:#83C092;">export</span><span style="color:#E69875;"> const</span><span style="color:#D3C6AA;"> ActionTypes </span><span style="color:#E69875;">=</span><span style="color:#D3C6AA;"> {</span></span>
<span class="line"><span style="color:#D3C6AA;">  INIT</span><span style="color:#859289;">:</span><span style="color:#DBBC7F;"> &quot;@@redux/INIT&quot;</span></span>
<span class="line"><span style="color:#D3C6AA;">};</span></span>
<span class="line"><span style="color:#83C092;">export</span><span style="color:#E67E80;"> default</span><span style="color:#E67E80;"> function</span><span style="color:#A7C080;"> createStore</span><span style="color:#D3C6AA;">(reducer,</span><span style="color:#D3C6AA;"> preloadedState,</span><span style="color:#D3C6AA;"> enhancer)</span><span style="color:#D3C6AA;"> {</span></span>
<span class="line"><span style="color:#859289;font-style:italic;">  //...初始条件的判断和设定</span></span>
<span class="line"><span style="color:#E67E80;">  function</span><span style="color:#A7C080;"> getState</span><span style="color:#D3C6AA;">()</span><span style="color:#D3C6AA;"> {</span></span>
<span class="line"><span style="color:#859289;font-style:italic;">    // getState方法的实现</span></span>
<span class="line"><span style="color:#D3C6AA;">  }</span></span>
<span class="line"><span style="color:#E67E80;">  function</span><span style="color:#A7C080;"> subscribe</span><span style="color:#D3C6AA;">()</span><span style="color:#D3C6AA;"> {</span></span>
<span class="line"><span style="color:#859289;font-style:italic;">    // subscribe方法的实现</span></span>
<span class="line"><span style="color:#D3C6AA;">  }</span></span>
<span class="line"><span style="color:#E67E80;">  function</span><span style="color:#A7C080;"> dispatch</span><span style="color:#D3C6AA;">()</span><span style="color:#D3C6AA;"> {</span></span>
<span class="line"><span style="color:#859289;font-style:italic;">    // dispatch方法的实现</span></span>
<span class="line"><span style="color:#D3C6AA;">  }</span></span>
<span class="line"><span style="color:#E67E80;">  function</span><span style="color:#A7C080;"> replaceReducer</span><span style="color:#D3C6AA;">()</span><span style="color:#D3C6AA;"> {</span></span>
<span class="line"><span style="color:#859289;font-style:italic;">    // replaceReducer方法的实现</span></span>
<span class="line"><span style="color:#D3C6AA;">  }</span></span>
<span class="line"><span style="color:#E67E80;">  function</span><span style="color:#A7C080;"> observable</span><span style="color:#D3C6AA;">()</span><span style="color:#D3C6AA;"> {</span></span>
<span class="line"><span style="color:#859289;font-style:italic;">    // observable方法的实现</span></span>
<span class="line"><span style="color:#859289;font-style:italic;">    // (源码中关于observable的部分可以忽略，这个是redux内部使用的。我们在开发中几乎几乎用不到)</span></span>
<span class="line"><span style="color:#D3C6AA;">  }</span></span>
<span class="line"><span style="color:#859289;font-style:italic;">  // store被创建后，自动分发一个&#39;INIT&#39; action。渲染出初始化的state树。</span></span>
<span class="line"><span style="color:#A7C080;">  dispatch</span><span style="color:#D3C6AA;">({</span><span style="color:#D3C6AA;"> type</span><span style="color:#859289;">:</span><span style="color:#D3C6AA;"> ActionTypes</span><span style="color:#859289;">.</span><span style="color:#D3C6AA;">INIT</span><span style="color:#D3C6AA;"> });</span></span>
<span class="line"><span style="color:#E67E80;">  return</span><span style="color:#D3C6AA;"> {</span></span>
<span class="line"><span style="color:#D3C6AA;">    dispatch,</span></span>
<span class="line"><span style="color:#D3C6AA;">    subscribe,</span></span>
<span class="line"><span style="color:#D3C6AA;">    getState,</span></span>
<span class="line"><span style="color:#D3C6AA;">    replaceReducer</span></span>
<span class="line"><span style="color:#D3C6AA;">  };</span></span>
<span class="line"><span style="color:#D3C6AA;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p><strong>完整源码</strong></p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki everforest-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#859289;font-style:italic;">// 首先定义了一个 ActionTypes 对象，它是一个 action，是一个 Redux 的私有 action，不允许外界触发，用来初始化 Store 的状态树和改变 reducers 后初始化 Store 的状态树。</span></span>
<span class="line"><span style="color:#83C092;">export</span><span style="color:#E69875;"> const</span><span style="color:#D3C6AA;"> ActionTypes </span><span style="color:#E69875;">=</span><span style="color:#D3C6AA;"> {</span></span>
<span class="line"><span style="color:#D3C6AA;">  INIT</span><span style="color:#859289;">:</span><span style="color:#DBBC7F;"> &quot;@@redux/INIT&quot;</span></span>
<span class="line"><span style="color:#D3C6AA;">};</span></span>
<span class="line"><span style="color:#859289;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#859289;font-style:italic;"> * 创建 store, 参数 reducer, state 以及中间件</span></span>
<span class="line"><span style="color:#859289;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#83C092;">export</span><span style="color:#E67E80;"> default</span><span style="color:#E67E80;"> function</span><span style="color:#A7C080;"> createStore</span><span style="color:#D3C6AA;">(reducer,</span><span style="color:#D3C6AA;"> preloadedState,</span><span style="color:#D3C6AA;"> enhancer)</span><span style="color:#D3C6AA;"> {</span></span>
<span class="line"><span style="color:#859289;font-style:italic;">  // 在平常的使用中，我们一般会省略第二个参数。比如，当我们需要使用redux中间件的时候，就会像第三个参数传递一个applyMiddleware()[返回值是一个function]。</span></span>
<span class="line"><span style="color:#859289;font-style:italic;">  // 如果，我们没有初始状态，则会省略第二个参数。这个时候，我们的函数调用形式为：</span></span>
<span class="line"><span style="color:#859289;font-style:italic;">  // const store = createStore(reducer, applyMiddleware(...))</span></span>
<span class="line"><span style="color:#E67E80;">  if</span><span style="color:#D3C6AA;"> (</span><span style="color:#E67E80;">typeof</span><span style="color:#D3C6AA;"> preloadedState</span><span style="color:#E69875;"> ===</span><span style="color:#DBBC7F;"> &quot;function&quot;</span><span style="color:#E69875;"> &amp;&amp;</span><span style="color:#E67E80;"> typeof</span><span style="color:#D3C6AA;"> enhancer</span><span style="color:#E69875;"> ===</span><span style="color:#DBBC7F;"> &quot;undefined&quot;</span><span style="color:#D3C6AA;">)</span><span style="color:#D3C6AA;"> {</span></span>
<span class="line"><span style="color:#D3C6AA;">    enhancer</span><span style="color:#E69875;"> =</span><span style="color:#D3C6AA;"> preloadedState;</span></span>
<span class="line"><span style="color:#D3C6AA;">    preloadedState</span><span style="color:#E69875;"> =</span><span style="color:#D699B6;"> undefined</span><span style="color:#D3C6AA;">;</span></span>
<span class="line"><span style="color:#D3C6AA;">  }</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#859289;font-style:italic;">  // 如果我们指定了reducer增强器enhancer</span></span>
<span class="line"><span style="color:#E67E80;">  if</span><span style="color:#D3C6AA;"> (</span><span style="color:#E67E80;">typeof</span><span style="color:#D3C6AA;"> enhancer</span><span style="color:#E69875;"> !==</span><span style="color:#DBBC7F;"> &quot;undefined&quot;</span><span style="color:#D3C6AA;">)</span><span style="color:#D3C6AA;"> {</span></span>
<span class="line"><span style="color:#859289;font-style:italic;">    // enhancer必须是一个函数</span></span>
<span class="line"><span style="color:#E67E80;">    if</span><span style="color:#D3C6AA;"> (</span><span style="color:#E67E80;">typeof</span><span style="color:#D3C6AA;"> enhancer</span><span style="color:#E69875;"> !==</span><span style="color:#DBBC7F;"> &quot;function&quot;</span><span style="color:#D3C6AA;">)</span><span style="color:#D3C6AA;"> {</span></span>
<span class="line"><span style="color:#E67E80;">      throw</span><span style="color:#E67E80;"> new</span><span style="color:#A7C080;"> Error</span><span style="color:#D3C6AA;">(</span><span style="color:#DBBC7F;">&quot;Expected the enhancer to be a function.&quot;</span><span style="color:#D3C6AA;">);</span></span>
<span class="line"><span style="color:#D3C6AA;">    }</span></span>
<span class="line"><span style="color:#859289;font-style:italic;">    // 这个函数接收createStore作为参数，并且返回一个函数，这个函数接收的参数是reducer,preloadedState</span></span>
<span class="line"><span style="color:#859289;font-style:italic;">    // 直接返回经过enhancer包装的对象</span></span>
<span class="line"><span style="color:#E67E80;">    return</span><span style="color:#A7C080;"> enhancer</span><span style="color:#D3C6AA;">(createStore)(reducer,</span><span style="color:#D3C6AA;"> preloadedState);</span></span>
<span class="line"><span style="color:#D3C6AA;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A7C080;">  </span></span>
<span class="line"><span style="color:#859289;font-style:italic;">  // 要求传递给createStore的第一个参数必须是一个函数</span></span>
<span class="line"><span style="color:#E67E80;">  if</span><span style="color:#D3C6AA;"> (</span><span style="color:#E67E80;">typeof</span><span style="color:#D3C6AA;"> reducer</span><span style="color:#E69875;"> !==</span><span style="color:#DBBC7F;"> &quot;function&quot;</span><span style="color:#D3C6AA;">)</span><span style="color:#D3C6AA;"> {</span></span>
<span class="line"><span style="color:#E67E80;">    throw</span><span style="color:#E67E80;"> new</span><span style="color:#A7C080;"> Error</span><span style="color:#D3C6AA;">(</span><span style="color:#DBBC7F;">&quot;Expected the reducer to be a function.&quot;</span><span style="color:#D3C6AA;">);</span></span>
<span class="line"><span style="color:#D3C6AA;">  }</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#859289;font-style:italic;">  // 保存初始的reducer</span></span>
<span class="line"><span style="color:#E69875;">  let</span><span style="color:#D3C6AA;"> currentReducer</span><span style="color:#E69875;"> =</span><span style="color:#D3C6AA;"> reducer</span></span>
<span class="line"><span style="color:#859289;font-style:italic;">  // 保存初始的state</span></span>
<span class="line"><span style="color:#E69875;">  let</span><span style="color:#D3C6AA;"> currentState</span><span style="color:#E69875;"> =</span><span style="color:#D3C6AA;"> preloadedState</span></span>
<span class="line"><span style="color:#859289;font-style:italic;">  // 保存所有的事件监听器</span></span>
<span class="line"><span style="color:#E69875;">  let</span><span style="color:#D3C6AA;"> currentListeners</span><span style="color:#E69875;"> =</span><span style="color:#D3C6AA;"> []</span></span>
<span class="line"><span style="color:#859289;font-style:italic;">  // 获取当前监听器的一个副本(相同的引用)</span></span>
<span class="line"><span style="color:#E69875;">  let</span><span style="color:#D3C6AA;"> nextListeners</span><span style="color:#E69875;"> =</span><span style="color:#D3C6AA;"> currentListeners</span></span>
<span class="line"><span style="color:#859289;font-style:italic;">  // 是否正在派发action</span></span>
<span class="line"><span style="color:#E69875;">  let</span><span style="color:#D3C6AA;"> isDispatching</span><span style="color:#E69875;"> =</span><span style="color:#D699B6;"> false</span></span>
<span class="line"></span>
<span class="line"><span style="color:#859289;font-style:italic;">  // 这个函数可以根据当前监听函数的列表生成新的下一个监听函数列表引用</span></span>
<span class="line"><span style="color:#859289;font-style:italic;">  // 如果nextListeners和currentListeners具有相同的引用，则获取一份当前事件监听器集合的一个副本保存到nextListeners中</span></span>
<span class="line"><span style="color:#E67E80;">  function</span><span style="color:#A7C080;"> ensureCanMutateNextListeners</span><span style="color:#D3C6AA;">()</span><span style="color:#D3C6AA;"> {</span></span>
<span class="line"><span style="color:#E67E80;">    if</span><span style="color:#D3C6AA;"> (nextListeners</span><span style="color:#E69875;"> ===</span><span style="color:#D3C6AA;"> currentListeners)</span><span style="color:#D3C6AA;"> {</span></span>
<span class="line"><span style="color:#D3C6AA;">      nextListeners</span><span style="color:#E69875;"> =</span><span style="color:#D3C6AA;"> currentListeners</span><span style="color:#859289;">.</span><span style="color:#A7C080;">slice</span><span style="color:#D3C6AA;">();</span></span>
<span class="line"><span style="color:#D3C6AA;">    }</span></span>
<span class="line"><span style="color:#D3C6AA;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#859289;font-style:italic;">  // 为什么要维护两份事件监听器列表(nextListeners,currentListeners)??</span></span>
<span class="line"><span style="color:#859289;font-style:italic;">  // 下面我们来解释</span></span>
<span class="line"></span>
<span class="line"><span style="color:#859289;font-style:italic;">  // 直接返回当前store的state</span></span>
<span class="line"><span style="color:#E67E80;">  function</span><span style="color:#A7C080;"> getState</span><span style="color:#D3C6AA;">()</span><span style="color:#D3C6AA;"> {</span></span>
<span class="line"><span style="color:#E67E80;">    return</span><span style="color:#D3C6AA;"> currentState;</span></span>
<span class="line"><span style="color:#D3C6AA;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#859289;font-style:italic;">  // 订阅事件，返回移除订阅函数</span></span>
<span class="line"><span style="color:#E67E80;">  function</span><span style="color:#A7C080;"> subscribe</span><span style="color:#D3C6AA;">(listener)</span><span style="color:#D3C6AA;"> {</span></span>
<span class="line"><span style="color:#859289;font-style:italic;">    // 事件监听器必须是函数，否则会抛出异常</span></span>
<span class="line"><span style="color:#E67E80;">    if</span><span style="color:#D3C6AA;"> (</span><span style="color:#E67E80;">typeof</span><span style="color:#D3C6AA;"> listener</span><span style="color:#E69875;"> !==</span><span style="color:#DBBC7F;"> &quot;function&quot;</span><span style="color:#D3C6AA;">)</span><span style="color:#D3C6AA;"> {</span></span>
<span class="line"><span style="color:#E67E80;">      throw</span><span style="color:#E67E80;"> new</span><span style="color:#A7C080;"> Error</span><span style="color:#D3C6AA;">(</span><span style="color:#DBBC7F;">&quot;Expected listener to be a function.&quot;</span><span style="color:#D3C6AA;">);</span></span>
<span class="line"><span style="color:#D3C6AA;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#859289;font-style:italic;">    // 这个事件监听器是否已经被取消的标志</span></span>
<span class="line"><span style="color:#E69875;">    let</span><span style="color:#D3C6AA;"> isSubscribed</span><span style="color:#E69875;"> =</span><span style="color:#D699B6;"> true</span></span>
<span class="line"></span>
<span class="line"><span style="color:#859289;font-style:italic;">    // 调用这个函数的结果就是生成一份当前事件监听器的一个副本保存到nextListeners中</span></span>
<span class="line"><span style="color:#A7C080;">    ensureCanMutateNextListeners</span><span style="color:#D3C6AA;">()</span></span>
<span class="line"><span style="color:#A7C080;">    </span></span>
<span class="line"><span style="color:#859289;font-style:italic;">    // 将新的事件监听器添加到nextListeners中</span></span>
<span class="line"><span style="color:#D3C6AA;">    nextListeners</span><span style="color:#859289;">.</span><span style="color:#A7C080;">push</span><span style="color:#D3C6AA;">(listener)</span></span>
<span class="line"><span style="color:#A7C080;">    </span></span>
<span class="line"><span style="color:#859289;font-style:italic;">    // 返回一个取消监听的函数</span></span>
<span class="line"><span style="color:#E67E80;">    return</span><span style="color:#E67E80;"> function</span><span style="color:#A7C080;"> unsubscribe</span><span style="color:#D3C6AA;">()</span><span style="color:#D3C6AA;"> {</span></span>
<span class="line"><span style="color:#859289;font-style:italic;">      // 如果这个监听器已经被取消了，则直接return</span></span>
<span class="line"><span style="color:#E67E80;">      if</span><span style="color:#D3C6AA;"> (</span><span style="color:#E69875;">!</span><span style="color:#D3C6AA;">isSubscribed)</span><span style="color:#D3C6AA;"> {</span></span>
<span class="line"><span style="color:#E67E80;">        return</span><span style="color:#D3C6AA;">;</span></span>
<span class="line"><span style="color:#D3C6AA;">      }</span></span>
<span class="line"><span style="color:#859289;font-style:italic;">      // 将监听器是否取消的标志设置为false</span></span>
<span class="line"><span style="color:#D3C6AA;">      isSubscribed</span><span style="color:#E69875;"> =</span><span style="color:#D699B6;"> false</span></span>
<span class="line"><span style="color:#859289;font-style:italic;">      // 再次生成一份事件监听器集合的副本</span></span>
<span class="line"><span style="color:#A7C080;">      ensureCanMutateNextListeners</span><span style="color:#D3C6AA;">()</span></span>
<span class="line"><span style="color:#859289;font-style:italic;">      // 获取到需要取消的事件监听器的索引</span></span>
<span class="line"><span style="color:#E69875;">      const</span><span style="color:#D3C6AA;"> index</span><span style="color:#E69875;"> =</span><span style="color:#D3C6AA;"> nextListeners</span><span style="color:#859289;">.</span><span style="color:#A7C080;">indexOf</span><span style="color:#D3C6AA;">(listener)</span></span>
<span class="line"><span style="color:#859289;font-style:italic;">      // 从事件监听器集合中删除这个事件监听器</span></span>
<span class="line"><span style="color:#D3C6AA;">      nextListeners</span><span style="color:#859289;">.</span><span style="color:#A7C080;">splice</span><span style="color:#D3C6AA;">(index,</span><span style="color:#D699B6;"> 1</span><span style="color:#D3C6AA;">)</span></span>
<span class="line"><span style="color:#D3C6AA;">    };</span></span>
<span class="line"><span style="color:#D3C6AA;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#859289;font-style:italic;">  // 从subscribe方法的源码中可以看出，每次在进行监听器的添加/删除之前，都会基于当前的监听器集合生成一个副本保存到nextListeners中。</span></span>
<span class="line"><span style="color:#859289;font-style:italic;">  // 下面我们继续看dispatch的源码:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#859289;font-style:italic;">  // 执行 reducer，并触发订阅事件</span></span>
<span class="line"><span style="color:#E67E80;">  function</span><span style="color:#A7C080;"> dispatch</span><span style="color:#D3C6AA;">(action)</span><span style="color:#D3C6AA;"> {</span></span>
<span class="line"><span style="color:#859289;font-style:italic;">    // https://lodash.com/docs#isPlainObject</span></span>
<span class="line"><span style="color:#859289;font-style:italic;">    // dispatch的参数就是我们需要派发的action，一定要保证这个action是一个纯粹的对象</span></span>
<span class="line"><span style="color:#859289;font-style:italic;">    // 如果不是一个纯粹的对象，则会抛出异常。</span></span>
<span class="line"><span style="color:#E67E80;">    if</span><span style="color:#D3C6AA;"> (</span><span style="color:#E69875;">!</span><span style="color:#A7C080;">isPlainObject</span><span style="color:#D3C6AA;">(action))</span><span style="color:#D3C6AA;"> {</span></span>
<span class="line"><span style="color:#E67E80;">      throw</span><span style="color:#E67E80;"> new</span><span style="color:#A7C080;"> Error</span><span style="color:#D3C6AA;">(</span></span>
<span class="line"><span style="color:#DBBC7F;">        &quot;Actions must be plain objects. &quot;</span><span style="color:#E69875;"> +</span></span>
<span class="line"><span style="color:#DBBC7F;">          &quot;Use custom middleware for async actions.&quot;</span></span>
<span class="line"><span style="color:#D3C6AA;">      );</span></span>
<span class="line"><span style="color:#D3C6AA;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#859289;font-style:italic;">    // 判断 action 是否有 type｛必须｝ 属性</span></span>
<span class="line"><span style="color:#859289;font-style:italic;">    // 派发的action必须有一个type属性(我们可以将这个属性认为就是action的身份证，这样redux才知道你派发的是哪个action，你需要做什么，该怎么为你做)</span></span>
<span class="line"><span style="color:#859289;font-style:italic;">    // 如果没有这个属性则会抛出异常</span></span>
<span class="line"><span style="color:#E67E80;">    if</span><span style="color:#D3C6AA;"> (</span><span style="color:#E67E80;">typeof</span><span style="color:#D3C6AA;"> action</span><span style="color:#859289;">.</span><span style="color:#D3C6AA;">type</span><span style="color:#E69875;"> ===</span><span style="color:#DBBC7F;"> &quot;undefined&quot;</span><span style="color:#D3C6AA;">)</span><span style="color:#D3C6AA;"> {</span></span>
<span class="line"><span style="color:#E67E80;">      throw</span><span style="color:#E67E80;"> new</span><span style="color:#A7C080;"> Error</span><span style="color:#D3C6AA;">(</span></span>
<span class="line"><span style="color:#DBBC7F;">        &#39;Actions may not have an undefined &quot;type&quot; property. &#39;</span><span style="color:#E69875;"> +</span></span>
<span class="line"><span style="color:#DBBC7F;">          &quot;Have you misspelled a constant?&quot;</span></span>
<span class="line"><span style="color:#D3C6AA;">      );</span></span>
<span class="line"><span style="color:#D3C6AA;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#859289;font-style:italic;">    // 如果正在 dispatch 则抛出错误</span></span>
<span class="line"><span style="color:#E67E80;">    if</span><span style="color:#D3C6AA;"> (isDispatching)</span><span style="color:#D3C6AA;"> {</span></span>
<span class="line"><span style="color:#E67E80;">      throw</span><span style="color:#E67E80;"> new</span><span style="color:#A7C080;"> Error</span><span style="color:#D3C6AA;">(</span><span style="color:#DBBC7F;">&quot;Reducers may not dispatch actions.&quot;</span><span style="color:#D3C6AA;">);</span></span>
<span class="line"><span style="color:#D3C6AA;">    }</span></span>
<span class="line"><span style="color:#859289;font-style:italic;">    // 对抛出 error 的兼容，但无论如何都会继续执行 isDispatching = false 的操作</span></span>
<span class="line"><span style="color:#E67E80;">    try</span><span style="color:#D3C6AA;"> {</span></span>
<span class="line"><span style="color:#D3C6AA;">      isDispatching</span><span style="color:#E69875;"> =</span><span style="color:#D699B6;"> true</span><span style="color:#D3C6AA;">;</span></span>
<span class="line"><span style="color:#859289;font-style:italic;">      // 派发action</span></span>
<span class="line"><span style="color:#859289;font-style:italic;">      // 实质就是将当前的state和你需要派发的action传递给reducer函数并返回一个新的state</span></span>
<span class="line"><span style="color:#D3C6AA;">      currentState</span><span style="color:#E69875;"> =</span><span style="color:#A7C080;"> currentReducer</span><span style="color:#D3C6AA;">(currentState,</span><span style="color:#D3C6AA;"> action);</span></span>
<span class="line"><span style="color:#D3C6AA;">    }</span><span style="color:#E67E80;"> finally</span><span style="color:#D3C6AA;"> {</span></span>
<span class="line"><span style="color:#D3C6AA;">      isDispatching</span><span style="color:#E69875;"> =</span><span style="color:#D699B6;"> false</span><span style="color:#D3C6AA;">;</span></span>
<span class="line"><span style="color:#D3C6AA;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#859289;font-style:italic;">    // 又多了一份事件监听器的列表，简单的说一下这三份列表的作用</span></span>
<span class="line"><span style="color:#859289;font-style:italic;">    // nextListeners: 保存这次dispatch后，需要触发的所有事件监听器的列表</span></span>
<span class="line"><span style="color:#859289;font-style:italic;">    // currentListeners: 保存一份nextListeners列表的副本</span></span>
<span class="line"><span style="color:#859289;font-style:italic;">    // listeners: 需要执行的列表</span></span>
<span class="line"><span style="color:#E69875;">    const</span><span style="color:#D3C6AA;"> listeners</span><span style="color:#E69875;"> =</span><span style="color:#D3C6AA;"> currentListeners</span><span style="color:#E69875;"> =</span><span style="color:#D3C6AA;"> nextListeners</span></span>
<span class="line"><span style="color:#E67E80;">    for</span><span style="color:#D3C6AA;"> (</span><span style="color:#E69875;">let</span><span style="color:#D3C6AA;"> i</span><span style="color:#E69875;"> =</span><span style="color:#D699B6;"> 0</span><span style="color:#D3C6AA;">;</span><span style="color:#D3C6AA;"> i</span><span style="color:#E69875;"> &lt;</span><span style="color:#D3C6AA;"> listeners</span><span style="color:#859289;">.</span><span style="color:#D3C6AA;">length;</span><span style="color:#D3C6AA;"> i</span><span style="color:#E69875;">++</span><span style="color:#D3C6AA;">)</span><span style="color:#D3C6AA;"> {</span></span>
<span class="line"><span style="color:#E69875;">      const</span><span style="color:#D3C6AA;"> listener</span><span style="color:#E69875;"> =</span><span style="color:#D3C6AA;"> listeners[i]</span></span>
<span class="line"><span style="color:#859289;font-style:italic;">      // 调用所有的事件监听器</span></span>
<span class="line"><span style="color:#A7C080;">      listener</span><span style="color:#D3C6AA;">()</span></span>
<span class="line"><span style="color:#D3C6AA;">    }</span></span>
<span class="line"><span style="color:#859289;font-style:italic;">    //  dispatch的返回值也是十分重要的，如果没有这个返回值，就不可能引入强大的中间件机制。</span></span>
<span class="line"><span style="color:#E67E80;">    return</span><span style="color:#D3C6AA;"> action;</span></span>
<span class="line"><span style="color:#D3C6AA;">  }</span></span>
<span class="line"><span style="color:#859289;font-style:italic;">  /**</span></span>
<span class="line"><span style="color:#859289;font-style:italic;">   * 动态替换 reducer</span></span>
<span class="line"><span style="color:#859289;font-style:italic;">   */</span></span>
<span class="line"><span style="color:#E67E80;">  function</span><span style="color:#A7C080;"> replaceReducer</span><span style="color:#D3C6AA;">(nextReducer)</span><span style="color:#D3C6AA;"> {</span></span>
<span class="line"><span style="color:#E67E80;">    if</span><span style="color:#D3C6AA;"> (</span><span style="color:#E67E80;">typeof</span><span style="color:#D3C6AA;"> nextReducer</span><span style="color:#E69875;"> !==</span><span style="color:#DBBC7F;"> &quot;function&quot;</span><span style="color:#D3C6AA;">)</span><span style="color:#D3C6AA;"> {</span></span>
<span class="line"><span style="color:#E67E80;">      throw</span><span style="color:#E67E80;"> new</span><span style="color:#A7C080;"> Error</span><span style="color:#D3C6AA;">(</span><span style="color:#DBBC7F;">&quot;Expected the nextReducer to be a function.&quot;</span><span style="color:#D3C6AA;">);</span></span>
<span class="line"><span style="color:#D3C6AA;">    }</span></span>
<span class="line"><span style="color:#D3C6AA;">    currentReducer</span><span style="color:#E69875;"> =</span><span style="color:#D3C6AA;"> nextReducer;</span></span>
<span class="line"><span style="color:#A7C080;">    dispatch</span><span style="color:#D3C6AA;">({</span><span style="color:#D3C6AA;"> type</span><span style="color:#859289;">:</span><span style="color:#D3C6AA;"> ActionTypes</span><span style="color:#859289;">.</span><span style="color:#D3C6AA;">INIT</span><span style="color:#D3C6AA;"> });</span></span>
<span class="line"><span style="color:#D3C6AA;">  }</span></span>
<span class="line"><span style="color:#A7C080;">  dispatch</span><span style="color:#D3C6AA;">({</span><span style="color:#D3C6AA;"> type</span><span style="color:#859289;">:</span><span style="color:#D3C6AA;"> ActionTypes</span><span style="color:#859289;">.</span><span style="color:#D3C6AA;">INIT</span><span style="color:#D3C6AA;"> });</span></span>
<span class="line"><span style="color:#E67E80;">  return</span><span style="color:#D3C6AA;"> {</span></span>
<span class="line"><span style="color:#D3C6AA;">    dispatch,</span></span>
<span class="line"><span style="color:#D3C6AA;">    subscribe,</span></span>
<span class="line"><span style="color:#D3C6AA;">    getState,</span></span>
<span class="line"><span style="color:#D3C6AA;">    replaceReducer</span></span>
<span class="line"><span style="color:#D3C6AA;">  };</span></span>
<span class="line"><span style="color:#D3C6AA;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br></div></div><h2 id="参考资料" tabindex="-1">参考资料 <a class="header-anchor" href="#参考资料" aria-label="Permalink to &quot;参考资料&quot;">​</a></h2><p><a href="https://segmentfault.com/a/1190000011835213" target="_blank" rel="noreferrer">redux 源码解读－－createStore 源码解析</a></p>`,20)]))}const C=n(o,[["render",r]]);export{u as __pageData,C as default};
